<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Streaming</title>
  <style>
    body { background:#111; color:#fff; font-family:sans-serif; text-align:center; padding-top:2rem }
    video { width:50%; border:4px solid #4caf50; border-radius:8px; }
    button { margin:1rem; padding:.5rem 1rem; background:#4caf50; border:none; border-radius:4px; cursor:pointer }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline muted></video><br/>
  <button onclick="startStream()">Iniciar TransmisiÃ³n</button>
  <button onclick="stopStream()">Detener TransmisiÃ³n</button>
  <div id="recorded"></div>

  <script>
    let stream, mediaRecorder, websocket, sessionId;
    let chuncks = [];

    async function startCamera() {
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById('video').srcObject = stream;
      console.log('ğŸ“· CÃ¡mara arrancada.');
    }

    async function startStream() {
      await startCamera();
      const res = await fetch('http://localhost:3000/stream/start',
      { method: 'POST' });
      sessionId = (await res.json()).id;
      console.log('âœ¨ SesiÃ³n:', sessionId);

      const mimeType = 'video/webm; codecs=vp9';
        if (!MediaRecorder.isTypeSupported(mimeType)) {
          console.error('Formato no soportado:', mimeType);
          return;
        }

      websocket = new WebSocket(`ws://localhost:8080?sessionId=${sessionId}`);
      websocket.binaryType = 'arraybuffer';

      websocket.onerror = (error) => {
        console.error('Error en WebSocket:', error);
      };

      websocket.onclose = (event) => {
        console.log('WebSocket cerrado:', event.code, event.reason);
      };

      websocket.onopen = () => {
        console.log('ğŸ”— WS abierto.');
        console.log("sesion ws abierta para ", sessionId)

        mediaRecorder = new MediaRecorder(stream,{
          mimeType: 'video/webm; codecs=vp9'
        });
        console.log('ğŸ¥ Recorder mimeType:', mediaRecorder);
        
        mediaRecorder.ondataavailable = async (e) => {
          if (e.data.size > 0) {
            const arrayBuffer = await e.data.arrayBuffer();
            chuncks.push(e.data)
            console.log(arrayBuffer);
            if (websocket.readyState === WebSocket.OPEN) {
              if (websocket.bufferedAmount > 10_000_000) { // por ejemplo 10 MB
                console.warn('WS buffer lleno, skip');
                return;
              }
              websocket.send(arrayBuffer);
            }
          }
        };
        
        mediaRecorder.onstop = () => {
          const blob = new Blob(chuncks, {type: "video/webm"});
          const videoUrl = URL.createObjectURL(blob);

          const recordedContainer = document.getElementById('recorded');
          recordedContainer.innerHTML = '';
            
          const newVideo = document.createElement("video");
          newVideo.src = videoUrl;
          newVideo.controls = true;
          newVideo.width = 640;

          recordedContainer.appendChild(newVideo);
          chuncks = [];
        }
        
          mediaRecorder.start(500);
    }
  }

    async function stopStream() {
      
      mediaRecorder.stop();
      
      stream.getTracks().forEach(t => t.stop());

      const res = await fetch(`http://localhost:3000/stream/stop/${sessionId}`, { method: 'POST' });
      if (!res.ok) console.error('âŒ Stop HTTP:', await res.text());
      else console.log('ğŸ›‘ Backend detenido.');

      websocket.close();

      console.log('ğŸ“· CÃ¡mara detenida.');
    }

  </script>
</body>
</html>
